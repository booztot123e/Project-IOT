<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>IoT Sensor Dashboard ‚Äî {{ device_id }}</title>

  <!-- Chart.js + time adapter -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>

  <style>
    :root{
      --bg:#f6f7f8; --card:#ffffff; --muted:#6b7280; --line:#e5e7eb; --ink:#111827;
      --temp:#f97316; --amps:#0ea5e9; --cycles:#8b5cf6; --level:#22c55e;
      --tick:#94a3b8; --grid:#eef2ff;
    }
    *{box-sizing:border-box}
    html{color-scheme:light}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:1280px;margin:18px auto;padding:0 16px}

    /* Topbar */
    .topbar{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    h1{margin:0 8px 0 0;font-size:22px;letter-spacing:.2px}
    .sub{font-size:12px;color:var(--muted)}
    .right{margin-left:auto;display:flex;gap:6px;flex-wrap:wrap;align-items:center}
    .btn{border:1px solid var(--line);background:#fff;padding:6px 10px;border-radius:10px;cursor:pointer;font-size:12px}
    .btn.active{background:#111;color:#fff;border-color:#111}
    .badge{padding:2px 8px;border-radius:999px;font-size:11px;background:#eef2ff;color:#4338ca}

    /* Cards */
    .grid{display:grid;gap:12px}
    .cards{grid-template-columns:repeat(4,minmax(0,1fr));margin-top:12px}
    @media(max-width:1024px){.cards{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:640px){.cards{grid-template-columns:1fr}}
    .card{background:var(--card);border-radius:14px;box-shadow:0 2px 6px rgba(0,0,0,.06);padding:14px}
    .k-label{font-size:12px;color:var(--muted)}
    .k-value{font-size:28px;font-weight:800;margin-top:4px;letter-spacing:.3px}
    .k-sub{font-size:11px;color:var(--muted);margin-top:4px}
    .chip{font-size:11px;padding:2px 8px;border-radius:999px;background:#e5f6ed;color:#16a34a;font-weight:700}

    /* Panels */
    .panel{background:var(--card);border-radius:14px;box-shadow:0 2px 6px rgba(0,0,0,.06);padding:12px}
    .two{grid-template-columns:1fr 1fr}
    .panel h3{margin:0 0 6px 2px;font-size:13px;color:var(--muted);display:flex;align-items:center;gap:8px}
    .chart-wrap{height:230px}
    canvas{width:100%;height:100%;background:#fff;border-radius:10px}

    /* Footer */
    .footer{display:flex;gap:14px;align-items:center;color:var(--muted);font-size:12px;margin-top:10px}
    .ok{color:#16a34a}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <h1>IoT Sensor Dashboard</h1>
      <div class="sub">Device: <b>{{ device_id }}</b> ‚Ä¢ Real-time monitoring</div>
      <div class="badge" id="now-str">‚Äî</div>
      <div class="badge" id="source-badge">source: ‚Äî</div>

      <div class="right">
        <button class="btn range active" data-hours="1">1h</button>
        <button class="btn range" data-hours="4">4h</button>
        <button class="btn range" data-hours="24">24h</button>
        <button id="btn-refresh" class="btn" title="Refresh">‚ü≥</button>
        <button id="btn-auto" class="btn" title="Toggle auto refresh">Auto: ON</button>
        <button id="btn-csv" class="btn" title="Download CSV">‚¨á CSV</button>
      </div>
    </div>

    <!-- KPI cards -->
    <div class="grid cards">
      <div class="card">
        <div class="k-label">Temperature</div>
        <div class="k-value"><span id="k-tempc">‚Äî</span><span style="font-weight:600">¬∞C</span></div>
        <div class="k-sub"><span id="k-tempf">‚Äî</span>¬∞F ‚Ä¢ <span id="k-temp-badge" class="chip" style="display:none"></span></div>
      </div>
      <div class="card">
        <div class="k-label">Current</div>
        <div class="k-value"><span id="k-amps">‚Äî</span><span style="font-weight:600">A</span></div>
        <div class="k-sub"><span id="k-amps-status" class="chip" style="display:none"></span></div>
      </div>
      <div class="card">
        <div class="k-label">Cycles</div>
        <div class="k-value"><span id="k-cycles">‚Äî</span></div>
        <div class="k-sub"><span id="k-cycles-status" class="chip" style="display:none"></span></div>
      </div>
      <div class="card">
        <div class="k-label">Level</div>
        <div class="k-value"><span id="k-level">‚Äî</span><span style="font-weight:600">cm</span></div>
        <div class="k-sub"><span id="k-level-pct">‚Äî</span>% ‚Ä¢ <span id="k-level-status" class="chip" style="display:none"></span></div>
      </div>
    </div>

    <!-- Charts -->
    <div class="grid two" style="margin-top:12px">
      <div class="panel">
        <h3>üå°Ô∏è Temperature Trend</h3>
        <div class="chart-wrap"><canvas id="c-temp"></canvas></div>
      </div>
      <div class="panel">
        <h3>‚ö° Current Flow</h3>
        <div class="chart-wrap"><canvas id="c-current"></canvas></div>
      </div>
      <div class="panel">
        <h3>üîÅ Cycle Rate</h3>
        <div class="chart-wrap"><canvas id="c-cycles"></canvas></div>
      </div>
      <div class="panel">
        <h3>üìè Level Monitoring</h3>
        <div class="chart-wrap"><canvas id="c-level"></canvas></div>
      </div>
    </div>

    <div class="footer">
      <span>‚Ä¢ Live Data</span>
      <span>Last updated: <span id="last-upd">‚Äî</span></span>
      <span>Records: <span id="rec-count">0</span></span>
      <span>Device Status: <span id="dev-status" class="ok">Online</span></span>
      <span>Uptime: <span id="uptime">‚Äî</span></span>
    </div>
  </div>

<script>
/* ===== clock badge ===== */
const nowLbl = ()=>{
  const d = new Date();
  document.querySelector('#now-str').textContent =
    d.toLocaleString(undefined,{hour12:false}) + ' (' +
    Intl.DateTimeFormat().resolvedOptions().timeZone + ')';
};
setInterval(nowLbl, 1000); nowLbl();

/* ===== theme ===== */
const css = getComputedStyle(document.documentElement);
const PAL = {
  temp:   css.getPropertyValue('--temp').trim()   || '#f97316',
  amps:   css.getPropertyValue('--amps').trim()   || '#0ea5e9',
  cycles: css.getPropertyValue('--cycles').trim() || '#8b5cf6',
  level:  css.getPropertyValue('--level').trim()  || '#22c55e',
  tick:   css.getPropertyValue('--tick').trim()   || '#94a3b8',
  grid:   css.getPropertyValue('--grid').trim()   || '#eef2ff',
};
function addAlpha(color, a){
  if(color.startsWith('#')){
    const c = color.length===4 ? color.slice(1).split('').map(h=>h+h).join('') : color.slice(1);
    const r=parseInt(c.slice(0,2),16), g=parseInt(c.slice(2,4),16), b=parseInt(c.slice(4,6),16);
    return `rgba(${r},${g},${b},${a})`;
  }
  const m = color.match(/rgba?\(([^)]+)\)/);
  if(m){ const [r,g,b] = m[1].split(',').slice(0,3).map(x=>+x.trim()); return `rgba(${r},${g},${b},${a})`; }
  return color;
}

/* ===== smart y scale (nice padding) ===== */
function niceRange(arr){
  const v = arr.filter(x=>Number.isFinite(x));
  if(!v.length) return {};
  const min = Math.min(...v), max = Math.max(...v);
  if(min===max) return { suggestedMin: min-1, suggestedMax: max+1 };
  const pad = (max-min)*0.08;
  return { suggestedMin: min-pad, suggestedMax: max+pad };
}

/* ===== Chart factory (area) ===== */
function makeAreaChart(canvasSel, label, color, {fill=true, stepped=false}={}){
  const ctx = document.querySelector(canvasSel).getContext('2d');
  return new Chart(ctx, {
    type: 'line',
    data: { labels: [], datasets: [{
      label, data: [], borderColor: color, borderWidth: 2,
      tension: .3, pointRadius: 0, pointHitRadius: 8, spanGaps:true,
      fill: fill,
      stepped: stepped,
      backgroundColor: (ctx)=>{
        if(!fill) return 'transparent';
        const area = ctx.chart.chartArea; if(!area) return addAlpha(color,0);
        const g = ctx.chart.ctx.createLinearGradient(0, area.top, 0, area.bottom);
        g.addColorStop(0, addAlpha(color, .22)); g.addColorStop(1, addAlpha(color, 0));
        return g;
      },
    }]},
    options: {
      responsive:true, maintainAspectRatio:false, normalized:true,
      animation:{ duration:400, easing:'easeOutQuad' },
      interaction:{ mode:'index', intersect:false },
      scales:{
        x:{ type:'time', time:{ unit:'minute' }, ticks:{ color:PAL.tick }, grid:{ display:false }},
        y:{ ticks:{ color:PAL.tick }, grid:{ color:PAL.grid } }
      },
      plugins:{
        legend:{ display:false },
        tooltip:{
          displayColors:false,
          callbacks:{ label:(it)=> `${label}: ${Number(it.parsed.y).toFixed(2)}` }
        },
        /* ‡∏•‡∏î noise ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ */
        decimation:{ enabled:true, algorithm:'lttb', samples: 200 }
      }
    }
  });
}

/* ===== build charts (cycles = step/no-fill) ===== */
const charts = {
  temp:    makeAreaChart('#c-temp',    'Temp (¬∞C)',   PAL.temp),
  current: makeAreaChart('#c-current', 'Current (A)', PAL.amps),
  cycles:  makeAreaChart('#c-cycles',  'Cycles',      PAL.cycles, {fill:false, stepped:'middle'}),
  level:   makeAreaChart('#c-level',   'Level (cm)',  PAL.level),
};

/* ===== helpers ===== */
const fmt2 = new Intl.NumberFormat('en-US', { maximumFractionDigits: 2 });
const fmt0 = new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 });
function setNum(sel, v, d=2){
  const el = document.querySelector(sel);
  if(!el) return;
  if(v == null || Number.isNaN(v)) { el.textContent = '‚Äî'; return; }
  el.textContent = d === 0 ? fmt0.format(v) : fmt2.format(v);
}
function setBadge(src){ const el = document.querySelector('#source-badge'); if(el) el.textContent = `source: ${src}`; }

/* ===== API ===== */
const PI_LOCAL_URL = '/api/latest';
const REFRESH_MS = 3000;

async function fetchWithTimeout(url, ms){
  return Promise.race([
    fetch(url, {cache:'no-store'}),
    new Promise((_,rej)=>setTimeout(()=>rej(new Error('timeout')), ms))
  ]);
}

async function getLatestSmart(){
  try{
    const r = await fetchWithTimeout(PI_LOCAL_URL, 800);
    if(r.ok){
      const j = await r.json();
      if(j && j.ok) return {...j, from:'local'};
    }
    throw new Error();
  }catch{
    return { ts_ms: Date.now(), temp:null, current:null, level:null, cycles:null, from:'offline' };
  }
}

/* ===== minutes loader (polished) ===== */
async function loadMinutesHours(hours=1){
  const r = await fetch(`/api/minutes?hours=${hours}`, {cache:'no-store'});
  const j = await r.json();
  if(!j.ok){ console.error(j); return; }
  let rows = j.rows || [];

  // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ñ‡∏ß ‚Üí ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏ä‡πà‡∏ß‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
  if(rows.length===0 && hours<24){
    return loadMinutesHours(hours<4?4:24);
  }

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á labels/series
  const labels  = rows.map(r => new Date(r.t_ms));
  const vTemp    = rows.map(r => Number(r.temp));
  const vCurrent = rows.map(r => Number(r.current));
  const vLevel   = rows.map(r => Number(r.level));
  const vCycles  = rows.map(r => Number(r.cycles));

  // update datasets
  charts.temp.data.labels    = labels; charts.temp.data.datasets[0].data    = vTemp;
  charts.current.data.labels = labels; charts.current.data.datasets[0].data = vCurrent;
  charts.level.data.labels   = labels; charts.level.data.datasets[0].data   = vLevel;
  charts.cycles.data.labels  = labels; charts.cycles.data.datasets[0].data  = vCycles;

  // smart y-range + decimation samples ‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤
  const samples = hours===1? 300 : hours===4? 400 : 600;
  charts.temp.options.plugins.decimation.samples    = samples;
  charts.current.options.plugins.decimation.samples = samples;
  charts.level.options.plugins.decimation.samples   = samples;
  charts.cycles.options.plugins.decimation.samples  = samples;

  Object.assign(charts.temp.options.scales.y,    niceRange(vTemp));
  Object.assign(charts.current.options.scales.y, niceRange(vCurrent));
  Object.assign(charts.level.options.scales.y,   niceRange(vLevel));
  Object.assign(charts.cycles.options.scales.y,  niceRange(vCycles));

  charts.temp.update(); charts.current.update(); charts.level.update(); charts.cycles.update();

  document.querySelector('#rec-count').textContent = String(rows.length);
  window.__lastRows = rows;
}

/* ===== KPI (top cards) ===== */
let autoOn=true, tKpi=0;
async function refreshKPI(){
  try{
    const d = await getLatestSmart();
    setNum("#k-tempc",  Number(d.temp),   2);
    setNum("#k-amps",   Number(d.current),2);
    setNum("#k-cycles", Number(d.cycles), 0);
    setNum("#k-level",  Number(d.level),  2);
    setBadge(d.from);
    const ts = d.ts_ms ? new Date(d.ts_ms) : null;
    document.querySelector('#last-upd').textContent = ts ? ts.toLocaleString() : '‚Äî';
  }catch{}
}
function setupAuto(){
  clearInterval(tKpi);
  if(autoOn) tKpi = setInterval(refreshKPI, REFRESH_MS);
}

/* ===== CSV ===== */
function downloadCSV(){
  const rows = window.__lastRows || [];
  const head = ['timestamp','temp_c','current_a','cycles','level_cm'];
  const lines = [head.join(',')];
  for(const r of rows){
    const ts = new Date(r.t_ms).toISOString();
    lines.push([ts, r.temp??'', r.current??'', r.cycles??'', r.level??''].join(','));
  }
  const blob = new Blob([lines.join('\n')], {type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `minutes_{{ device_id }}.csv`.replace(/\s+/g,'');
  a.click(); URL.revokeObjectURL(a.href);
}

/* ===== UI ===== */
document.querySelectorAll('.btn.range').forEach(b=>{
  b.addEventListener('click', ()=>{
    document.querySelectorAll('.btn.range').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    loadMinutesHours(parseInt(b.dataset.hours||'1',10));
  });
});
document.querySelector('#btn-refresh').addEventListener('click', ()=>{
  refreshKPI();
  const act = document.querySelector('.btn.range.active');
  loadMinutesHours(parseInt(act?.dataset.hours||'1',10));
});
document.querySelector('#btn-auto').addEventListener('click', ()=>{
  autoOn = !autoOn;
  document.querySelector('#btn-auto').textContent = 'Auto: ' + (autoOn?'ON':'OFF');
  setupAuto();
});
document.querySelector('#btn-csv').addEventListener('click', downloadCSV);

/* ===== Kickoff ===== */
(async()=>{
  await refreshKPI();
  await loadMinutesHours(24);   // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà 24h ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≤‡∏ü‡∏°‡∏≤‡πÅ‡∏ô‡πà
  setupAuto();
})();
</script>
</body>
</html>
