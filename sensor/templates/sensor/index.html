<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>IoT Sensor Dashboard ‚Äî {{ device_id }}</title>

  <!-- Chart.js + time adapter -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>

  <style>
    :root{
      --bg:#f6f7f8; --card:#ffffff; --muted:#6b7280; --line:#e5e7eb; --ink:#111827;
      --temp:#f97316; --amps:#0ea5e9; --cycles:#8b5cf6; --level:#22c55e;
      --tick:#94a3b8; --grid:#eef2ff;
    }
    *{box-sizing:border-box}
    html{color-scheme:light}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:1280px;margin:18px auto;padding:0 16px}

    /* Topbar */
    .topbar{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    h1{margin:0 8px 0 0;font-size:22px;letter-spacing:.2px}
    .sub{font-size:12px;color:var(--muted)}
    .right{margin-left:auto;display:flex;gap:6px;flex-wrap:wrap;align-items:center}
    .btn{border:1px solid var(--line);background:#fff;padding:6px 10px;border-radius:10px;cursor:pointer;font-size:12px}
    .btn.active{background:#111;color:#fff;border-color:#111}
    .badge{padding:2px 8px;border-radius:999px;font-size:11px;background:#eef2ff;color:#4338ca}

    /* Cards */
    .grid{display:grid;gap:12px}
    .cards{grid-template-columns:repeat(4,minmax(0,1fr));margin-top:12px}
    @media(max-width:1024px){.cards{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:640px){.cards{grid-template-columns:1fr}}
    .card{background:var(--card);border-radius:14px;box-shadow:0 2px 6px rgba(0,0,0,.06);padding:14px}
    .k-label{font-size:12px;color:var(--muted)}
    .k-value{font-size:28px;font-weight:800;margin-top:4px;letter-spacing:.3px}
    .k-sub{font-size:11px;color:var(--muted);margin-top:4px}
    .chip{font-size:11px;padding:2px 8px;border-radius:999px;background:#e5f6ed;color:#16a34a;font-weight:700}

    /* Panels */
    .panel{background:var(--card);border-radius:14px;box-shadow:0 2px 6px rgba(0,0,0,.06);padding:12px}
    .two{grid-template-columns:1fr 1fr}
    .panel h3{margin:0 0 6px 2px;font-size:13px;color:var(--muted);display:flex;align-items:center;gap:8px}
    .chart-wrap{height:230px}
    canvas{width:100%;height:100%;background:#fff;border-radius:10px}

    /* Footer */
    .footer{display:flex;gap:14px;align-items:center;color:var(--muted);font-size:12px;margin-top:10px}
    .ok{color:#16a34a}

    /* Alert flash */
    .alert-flash{ animation:alertFlash 1.8s ease-in-out; }
    @keyframes alertFlash{
      0%,100%{ box-shadow:0 2px 6px rgba(0,0,0,.06); }
      50%{ box-shadow:0 2px 14px rgba(220,38,38,.35); }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <h1>IoT Sensor Dashboard</h1>
      <div class="sub">Device: <b>{{ device_id }}</b> ‚Ä¢ Real-time monitoring</div>
      <div class="badge" id="now-str">‚Äî</div>
      <div class="badge" id="source-badge">source: ‚Äî</div>

      <div class="right">
        <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡∏°‡πà -->
        <button class="btn range active" data-hours="24">1d</button>
        <button class="btn range" data-hours="72">3d</button>
        <button class="btn range" data-hours="168">7d</button>
        <button id="btn-refresh" class="btn" title="Refresh">‚ü≥</button>
        <button id="btn-auto" class="btn" title="Toggle auto refresh">Auto: ON</button>
        <button id="btn-csv" class="btn" title="Download CSV">‚¨á CSV</button>
      </div>
    </div>

    <!-- KPI cards -->
    <div class="grid cards">
      <div class="card">
        <div class="k-label">Temperature</div>
        <div class="k-value"><span id="k-tempc">‚Äî</span><span style="font-weight:600">¬∞C</span></div>
        <div class="k-sub"><span id="k-tempf">‚Äî</span>¬∞F ‚Ä¢ <span id="k-temp-badge" class="chip" style="display:none"></span></div>
      </div>
      <div class="card">
        <div class="k-label">Current</div>
        <div class="k-value"><span id="k-amps">‚Äî</span><span style="font-weight:600">A</span></div>
        <div class="k-sub"><span id="k-amps-status" class="chip" style="display:none"></span></div>
      </div>
      <div class="card">
        <div class="k-label">Cycles</div>
        <div class="k-value"><span id="k-cycles">‚Äî</span></div>
        <div class="k-sub"><span id="k-cycles-status" class="chip" style="display:none"></span></div>
      </div>
      <div class="card">
        <div class="k-label">Level</div>
        <div class="k-value"><span id="k-level">‚Äî</span><span style="font-weight:600">cm</span></div>
        <div class="k-sub"><span id="k-level-pct">‚Äî</span>% ‚Ä¢ <span id="k-level-status" class="chip" style="display:none"></span></div>
      </div>
    </div>

    <!-- Charts -->
    <div class="grid two" style="margin-top:12px">
      <div class="panel">
        <h3>üå°Ô∏è Temperature Trend</h3>
        <div class="chart-wrap"><canvas id="c-temp"></canvas></div>
      </div>
      <div class="panel">
        <h3>‚ö° Current Flow</h3>
        <div class="chart-wrap"><canvas id="c-current"></canvas></div>
      </div>
      <div class="panel">
        <h3>üîÅ Cycle Rate</h3>
        <div class="chart-wrap"><canvas id="c-cycles"></canvas></div>
      </div>
      <div class="panel">
        <h3>üìè Level Monitoring</h3>
        <div class="chart-wrap"><canvas id="c-level"></canvas></div>
      </div>
    </div>

    <!-- Alerts Panel -->
    <div id="alerts-panel" class="panel" style="margin-top:12px">
      <div style="display:flex;align-items:center;gap:8px">
        <h3 style="margin:0;font-size:14px;color:#6b7280">‚ö† Alerts</h3>
        <label style="margin-left:auto;display:flex;align-items:center;gap:6px;font-size:12px;color:#6b7280">
          <input id="alerts-mute" type="checkbox"/> Mute
        </label>
        <span id="alerts-count" style="font-size:12px;color:#6b7280">‚Äî</span>
      </div>

      <!-- Alert controls (Enable/Test sound) -->
      <div style="display:flex;align-items:center;gap:10px;margin-top:6px">
        <button id="alerts-enable-sound" class="btn" style="padding:4px 8px">üîî Enable sound</button>
        <button id="alerts-test-beep" class="btn" style="padding:4px 8px">‚ñ∂ Test beep</button>
      </div>

      <div id="alerts-list" style="margin-top:8px;font-size:13px;color:#374151">Loading‚Ä¶</div>
    </div>

    <div class="footer">
      <span>‚Ä¢ Live Data</span>
      <span>Last updated: <span id="last-upd">‚Äî</span></span>
      <span>Records: <span id="rec-count">0</span></span>
      <span>Device Status: <span id="dev-status" class="ok">Online</span></span>
      <span>Uptime: <span id="uptime">‚Äî</span></span>
    </div>
  </div>

<script>
/* ===== clock badge ===== */
const nowLbl = ()=>{
  const d = new Date();
  document.querySelector('#now-str').textContent =
    d.toLocaleString(undefined,{hour12:false}) + ' (' +
    Intl.DateTimeFormat().resolvedOptions().timeZone + ')';
};
setInterval(nowLbl, 1000); nowLbl();

/* ===== theme ===== */
const css = getComputedStyle(document.documentElement);
const PAL = {
  temp:   css.getPropertyValue('--temp').trim()   || '#f97316',
  amps:   css.getPropertyValue('--amps').trim()   || '#0ea5e9',
  cycles: css.getPropertyValue('--cycles').trim() || '#8b5cf6',
  level:  css.getPropertyValue('--level').trim()  || '#22c55e',
  tick:   css.getPropertyValue('--tick').trim()   || '#94a3b8',
  grid:   css.getPropertyValue('--grid').trim()   || '#eef2ff',
};
function addAlpha(color, a){
  if(color.startsWith('#')){
    const c = color.length===4 ? color.slice(1).split('').map(h=>h+h).join('') : color.slice(1);
    const r=parseInt(c.slice(0,2),16), g=parseInt(c.slice(2,4),16), b=parseInt(c.slice(4,6),16);
    return `rgba(${r},${g},${b},${a})`;
  }
  const m = color.match(/rgba?\(([^)]+)\)/);
  if(m){ const [r,g,b] = m[1].split(',').slice(0,3).map(x=>+x.trim()); return `rgba(${r},${g},${b},${a})`; }
  return color;
}

/* ===== smart y scale ===== */
function niceRangeFromSeries(series){
  const vals = series.map(p => p?.y).filter(v => Number.isFinite(v));
  if(!vals.length) return {};
  const min = Math.min(...vals), max = Math.max(...vals);
  if(min===max) return { suggestedMin:min-1, suggestedMax:max+1 };
  const pad = (max-min)*0.08;
  return { suggestedMin:min-pad, suggestedMax:max+pad };
}

/* ===== Chart factory ===== */
function makeAreaChart(canvasSel, label, color, {fill=true, stepped=false}={}){
  const ctx = document.querySelector(canvasSel).getContext('2d');
  return new Chart(ctx, {
    type:'line',
    data:{ labels:[], datasets:[{
      label, data:[], borderColor:color, borderWidth:2,
      tension:.28, pointRadius:0, pointHitRadius:8,
      spanGaps:false, fill, stepped,
      backgroundColor:(c)=>{
        if(!fill) return 'transparent';
        const area = c.chart.chartArea; if(!area) return addAlpha(color,0);
        const g = c.chart.ctx.createLinearGradient(0, area.top, 0, area.bottom);
        g.addColorStop(0, addAlpha(color,.22)); g.addColorStop(1, addAlpha(color,0));
        return g;
      },
    }]},
    options:{
      parsing:false, /* ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏õ‡πâ‡∏≠‡∏ô {x,y} ‡πÄ‡∏≠‡∏á */
      responsive:true, maintainAspectRatio:false, normalized:true,
      animation:{duration:400, easing:'easeOutQuad'},
      interaction:{mode:'index', intersect:false},
      scales:{
        x:{type:'time', time:{unit:'day'}, ticks:{color:PAL.tick}, grid:{display:false}},
        y:{ticks:{color:PAL.tick}, grid:{color:PAL.grid}}
      },
      plugins:{
        legend:{display:false},
        tooltip:{displayColors:false, callbacks:{label:(it)=>`${label}: ${Number(it.parsed.y).toFixed(2)}`}},
        decimation:{enabled:true, algorithm:'lttb', samples:300}
      }
    }
  });
}

/* ===== build charts ===== */
const charts = {
  temp:    makeAreaChart('#c-temp',    'Temp (¬∞C)',   PAL.temp),
  current: makeAreaChart('#c-current', 'Current (A)', PAL.amps),
  cycles:  makeAreaChart('#c-cycles',  'Cycles',      PAL.cycles, {fill:false, stepped:'middle'}),
  level:   makeAreaChart('#c-level',   'Level (cm)',  PAL.level),
};

/* ===== helpers ===== */
const fmt2 = new Intl.NumberFormat('en-US',{maximumFractionDigits:2});
const fmt0 = new Intl.NumberFormat('en-US',{maximumFractionDigits:0});
function setNum(sel, v, d=2){
  const el=document.querySelector(sel);
  if(!el) return;
  if(v==null || Number.isNaN(v)) { el.textContent='‚Äî'; return; }
  el.textContent = d===0 ? fmt0.format(v) : fmt2.format(v);
}
function setBadge(src){ const el=document.querySelector('#source-badge'); if(el) el.textContent=`source: ${src}`; }

/* ===== API ===== */
const PI_LOCAL_URL = '/api/latest';
const REFRESH_MS = 3000;

async function fetchWithTimeout(url, ms){
  return Promise.race([
    fetch(url,{cache:'no-store'}),
    new Promise((_,rej)=>setTimeout(()=>rej(new Error('timeout')), ms))
  ]);
}
async function getLatestSmart(){
  try{
    const r = await fetchWithTimeout(PI_LOCAL_URL, 800);
    if(r.ok){ const j=await r.json(); if(j && j.ok) return {...j, from:'local'}; }
    throw new Error();
  }catch{
    return { ts_ms:Date.now(), temp:null, current:null, level:null, cycles:null, from:'offline' };
  }
}

/* ===== ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å unit ‡πÄ‡∏ß‡∏•‡∏≤ & samples ===== */
function chooseTimeUnit(hours){
  if(hours <= 6) return 'minute';
  if(hours <= 48) return 'hour';
  return 'day';
}
function chooseSamples(hours){
  if(hours <= 6)  return 300;
  if(hours <= 48) return 500;
  return 800;
}

/* ‡πÉ‡∏™‡πà null ‡∏Ñ‡∏±‡πà‡∏ô‡∏£‡∏π‡πÇ‡∏´‡∏ß‡πà ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÄ‡∏™‡πâ‡∏ô */
function buildSeries(rows, key, hours){
  const gapMs = hours <= 24 ? 15*60*1000 : 60*60*1000; // >15 ‡∏ô‡∏≤‡∏ó‡∏µ (1d) / >1‡∏ä‡∏°. (3‚Äì7d) = gap
  const out = [];
  let prev = null;
  for(const r of rows){
    const t = Number(r.t_ms);
    const v = r[key] != null ? Number(r[key]) : null;
    if(prev && t - prev > gapMs){
      out.push({x:new Date(prev + 1), y:null}); // ‡∏Ñ‡∏±‡πà‡∏ô‡πÉ‡∏´‡πâ Chart.js ‡∏ï‡∏±‡∏î‡πÄ‡∏™‡πâ‡∏ô
    }
    out.push({x:new Date(t), y: Number.isFinite(v) ? v : null});
    prev = t;
  }
  return out;
}

/* ===== ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö 1/3/7 ‡∏ß‡∏±‡∏ô) ===== */
async function loadMinutesHours(hours=24){
  const r = await fetch(`/api/minutes?hours=${hours}`, {cache:'no-store'});
  const j = await r.json();
  if(!j.ok){ console.error(j); return; }
  let rows = j.rows || [];

  // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏•‡∏≠‡∏á‡∏Ç‡∏¢‡∏≤‡∏¢‡∏ä‡πà‡∏ß‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
  if(rows.length === 0){
    if(hours < 72)  return loadMinutesHours(72);
    if(hours < 168) return loadMinutesHours(168);
  }

  // ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡∏ô‡πÄ‡∏ß‡∏•‡∏≤
  const tUnit = chooseTimeUnit(hours);
  charts.temp.options.scales.x.time.unit    = tUnit;
  charts.current.options.scales.x.time.unit = tUnit;
  charts.level.options.scales.x.time.unit   = tUnit;
  charts.cycles.options.scales.x.time.unit  = tUnit;

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á series ‡πÅ‡∏ö‡∏ö {x,y} ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏à‡∏∏‡∏î null
  const sTemp    = buildSeries(rows, 'temp',    hours);
  const sCurrent = buildSeries(rows, 'current', hours);
  const sLevel   = buildSeries(rows, 'level',   hours);
  const sCycles  = buildSeries(rows, 'cycles',  hours);

  const connectShort = hours <= 24; // ‡∏ä‡πà‡∏ß‡∏á‡∏™‡∏±‡πâ‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÑ‡∏î‡πâ, ‡∏ä‡πà‡∏ß‡∏á‡∏¢‡∏≤‡∏ß‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°
  charts.temp.data.datasets[0].spanGaps    = connectShort;
  charts.current.data.datasets[0].spanGaps = connectShort;
  charts.level.data.datasets[0].spanGaps   = connectShort;
  charts.cycles.data.datasets[0].spanGaps  = false; // cycles ‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°

  charts.temp.data.datasets[0].data    = sTemp;
  charts.current.data.datasets[0].data = sCurrent;
  charts.level.data.datasets[0].data   = sLevel;
  charts.cycles.data.datasets[0].data  = sCycles;

  // decimation: ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏¢‡∏≠‡∏∞
  const samples = chooseSamples(hours);
  const count = rows.length;
  const enableDecim = count > samples * 1.2;
  for (const c of [charts.temp, charts.current, charts.level, charts.cycles]) {
    c.options.plugins.decimation.enabled = enableDecim;
    c.options.plugins.decimation.samples = samples;
  }

  // ‡∏õ‡∏£‡∏±‡∏ö y-range ‡∏ï‡∏≤‡∏°‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á
  Object.assign(charts.temp.options.scales.y,    niceRangeFromSeries(sTemp));
  Object.assign(charts.current.options.scales.y, niceRangeFromSeries(sCurrent));
  Object.assign(charts.level.options.scales.y,   niceRangeFromSeries(sLevel));
  Object.assign(charts.cycles.options.scales.y,  niceRangeFromSeries(sCycles));

  charts.temp.update(); charts.current.update(); charts.level.update(); charts.cycles.update();
  document.querySelector('#rec-count').textContent = String(rows.length);
  window.__lastRows = rows;
}

/* ===== KPI (top cards) ===== */
let autoOn=true, tKpi=0;
async function refreshKPI(){
  try{
    const d = await getLatestSmart();
    setNum("#k-tempc",  Number(d.temp),   2);
    setNum("#k-amps",   Number(d.current),2);
    setNum("#k-cycles", Number(d.cycles), 0);
    setNum("#k-level",  Number(d.level),  2);
    setBadge(d.from);
    const ts = d.ts_ms ? new Date(d.ts_ms) : null;
    document.querySelector('#last-upd').textContent = ts ? ts.toLocaleString() : '‚Äî';
  }catch{}
}
function setupAuto(){ clearInterval(tKpi); if(autoOn) tKpi=setInterval(refreshKPI, REFRESH_MS); }

/* ===== CSV ===== */
function downloadCSV(){
  const rows = window.__lastRows || [];
  const head = ['timestamp','temp_c','current_a','cycles','level_cm'];
  const lines = [head.join(',')];
  for(const r of rows){
    const ts = new Date(r.t_ms).toISOString();
    lines.push([ts, r.temp??'', r.current??'', r.cycles??'', r.level??''].join(','));
  }
  const blob = new Blob([lines.join('\n')],{type:'text/csv'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`minutes_{{ device_id }}.csv`.replace(/\s+/g,'');
  a.click(); URL.revokeObjectURL(a.href);
}

/* ===== UI ===== */
document.querySelectorAll('.btn.range').forEach(b=>{
  b.addEventListener('click', ()=>{
    document.querySelectorAll('.btn.range').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    const h = parseInt(b.dataset.hours||'24',10);
    loadMinutesHours(h);
  });
});
document.querySelector('#btn-refresh').addEventListener('click', ()=>{
  refreshKPI();
  const act=document.querySelector('.btn.range.active');
  loadMinutesHours(parseInt(act?.dataset.hours||'24',10));
});
document.querySelector('#btn-auto').addEventListener('click', ()=>{
  autoOn=!autoOn;
  document.querySelector('#btn-auto').textContent='Auto: '+(autoOn?'ON':'OFF');
  setupAuto();
});
document.querySelector('#btn-csv').addEventListener('click', downloadCSV);

/* ===================================================================== */
/* =======================  Alerts (Mute + Sound)  ===================== */
/* ===================================================================== */
let ALERTS_LAST_TS = Number(localStorage.getItem('alerts.lastTs') || '0');
let ALERTS_MUTE    = localStorage.getItem('alerts.mute') === '1';
const $mute  = document.getElementById('alerts-mute');
const $list  = document.getElementById('alerts-list');
const $count = document.getElementById('alerts-count');
const $panel = document.getElementById('alerts-panel');
if($mute) $mute.checked = ALERTS_MUTE;

/* Blink title */
let BLINK_INT=0, ORIG_TITLE=document.title;
function blinkStart(){ if(BLINK_INT) return; let on=false; BLINK_INT=setInterval(()=>{ document.title = on?'‚ö† ALERT!':ORIG_TITLE; on=!on; }, 700); }
function blinkStop(){ if(BLINK_INT){ clearInterval(BLINK_INT); BLINK_INT=0; document.title=ORIG_TITLE; } }

/* Render list */
function renderAlertRows(rows){
  if(!rows.length){ $list.textContent='No alerts'; blinkStop(); return; }
  $list.innerHTML = rows.map(x=>{
    const t = new Date(x.ts_ms).toLocaleString();
    const open = x.state==='open';
    const color=open?'#b91c1c':'#16a34a';
    const bkg  =open?'#fee2e2':'#e5f6ed';
    const sev  =(x.severity||'').toUpperCase();
    return `
      <div style="display:flex;gap:8px;align-items:center;border-bottom:1px solid #eee;padding:6px 0">
        <span style="font-size:10px;background:${bkg};color:${color};padding:2px 6px;border-radius:999px">${x.state}</span>
        <b>${x.metric}</b>
        <span>value=${Number(x.value).toFixed(2)}</span>
        <span>th=${x.threshold}</span>
        <span style="color:#6b7280">(${sev||'‚Äî'})</span>
        <span style="margin-left:auto;color:#6b7280">${t}</span>
      </div>`;
  }).join('');
}

/* ====== Sound unlock & 10s Alarm (WebAudio, louder) ====== */
let AUDIO_CTX = null; let MASTER_GAIN = null;
let AUDIO_ENABLED = localStorage.getItem('alerts.audioEnabled') === '1';
const btnEnable = document.getElementById('alerts-enable-sound');
const btnTest   = document.getElementById('alerts-test-beep');
let ALARM_TIMER = null; let ALARM_END_AT = 0;

async function ensureAudioUnlocked() {
  try {
    if (!AUDIO_CTX) {
      const AC = window.AudioContext || window.webkitAudioContext;
      if (!AC) return false;
      AUDIO_CTX = new AC();
      MASTER_GAIN = AUDIO_CTX.createGain();
      MASTER_GAIN.gain.value = 0.0;
      MASTER_GAIN.connect(AUDIO_CTX.destination);
    }
    if (AUDIO_CTX.state === 'suspended') await AUDIO_CTX.resume();
    AUDIO_ENABLED = true;
    localStorage.setItem('alerts.audioEnabled', '1');
    if (btnEnable) { btnEnable.textContent = 'üîî Sound ON'; btnEnable.classList.add('active'); }
    return true;
  } catch { return false; }
}
function tone(freq = 1100, ms = 180) {
  if (!AUDIO_CTX || !MASTER_GAIN) return;
  const ctx = AUDIO_CTX;
  const o = ctx.createOscillator();
  const g = ctx.createGain();
  o.type = 'square';
  o.frequency.value = freq;
  g.gain.value = 0.22;
  o.connect(g).connect(MASTER_GAIN);
  const now = ctx.currentTime;
  o.start(now);
  g.gain.setValueAtTime(g.gain.value, now);
  g.gain.exponentialRampToValueAtTime(0.0001, now + ms / 1000);
  o.stop(now + ms / 1000 + 0.02);
}
function startAlarm(ms = 10000) {
  if (ALERTS_MUTE || !AUDIO_ENABLED || !AUDIO_CTX) return;
  stopAlarm(false);
  MASTER_GAIN.gain.setTargetAtTime(1.0, AUDIO_CTX.currentTime, 0.01);
  const pattern = () => { tone(1250,190); setTimeout(()=>tone(900,190), 200); };
  pattern();
  ALARM_END_AT = Date.now() + ms;
  ALARM_TIMER = setInterval(() => {
    if (Date.now() >= ALARM_END_AT || ALERTS_MUTE || !AUDIO_ENABLED) { stopAlarm(); return; }
    pattern();
  }, 450);
}
function stopAlarm(reset = true) {
  if (ALARM_TIMER) { clearInterval(ALARM_TIMER); ALARM_TIMER = null; }
  if (AUDIO_CTX && MASTER_GAIN) MASTER_GAIN.gain.setTargetAtTime(0.0, AUDIO_CTX.currentTime, 0.05);
  if (reset) ALARM_END_AT = 0;
}
btnEnable?.addEventListener('click', async () => {
  const ok = await ensureAudioUnlocked();
  if (!ok) alert('‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‡∏•‡∏≠‡∏á‡πÅ‡∏ï‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠/‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏á‡∏µ‡∏¢‡∏ö ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
});
btnTest?.addEventListener('click', async () => {
  if (!AUDIO_ENABLED) await ensureAudioUnlocked();
  startAlarm(1500);
});
const oneTimeUnlock = async () => { if (!AUDIO_ENABLED) await ensureAudioUnlocked(); document.removeEventListener('pointerdown', oneTimeUnlock, {capture:true}); };
document.addEventListener('pointerdown', oneTimeUnlock, {capture:true});
if (AUDIO_ENABLED && btnEnable) { btnEnable.textContent = 'üîî Sound ON'; btnEnable.classList.add('active'); }

/* Poll alerts */
async function fetchAlerts(){
  try{
    const r = await fetch('/api/alerts/recent/?limit=20',{cache:'no-store'});
    if(!r.ok) throw new Error(r.status);
    const j = await r.json(); if(!j.ok) throw 0;
    const rows = j.rows || [];
    const openCount = rows.filter(x=>x.state==='open').length;
    $count.textContent = `${openCount} open / ${rows.length} recent`;
    renderAlertRows(rows);

    const newest = rows.reduce((m,x)=>Math.max(m, Number(x.ts_ms)||0), 0);
    if(newest > ALERTS_LAST_TS){
      ALERTS_LAST_TS = newest;
      localStorage.setItem('alerts.lastTs', String(ALERTS_LAST_TS));
      startAlarm(10000); // ‡∏î‡∏±‡∏á ~10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
      blinkStart();
      if($panel){ $panel.classList.add('alert-flash'); setTimeout(()=>$panel.classList.remove('alert-flash'), 1800); }
    }
    if(openCount===0) { blinkStop(); stopAlarm(); }

    const ds = document.getElementById('dev-status');
    if(ds){
      if(openCount>0){ ds.textContent=`ALERT √ó${openCount}`; ds.classList.remove('ok'); ds.style.color='#b91c1c'; }
      else           { ds.textContent='Online';            ds.classList.add('ok');     ds.style.color=''; }
    }
  }catch(e){ /* silent */ }
}

/* events */
if($mute){
  $mute.addEventListener('change', ()=>{
    ALERTS_MUTE = $mute.checked;
    localStorage.setItem('alerts.mute', ALERTS_MUTE ? '1':'0');
    if(ALERTS_MUTE) { blinkStop(); stopAlarm(); }
  });
}

/* ===== Kickoff ===== */
(async()=>{
  await refreshKPI();
  await loadMinutesHours(24); // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà 1 ‡∏ß‡∏±‡∏ô
  setupAuto();
  await fetchAlerts();
  setInterval(fetchAlerts, 10000);
})();
</script>
</body>
</html>
