<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>IoT Sensor Dashboard ‚Äî {{ device_id }}</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#f6f7f8; --card:#ffffff; --muted:#6b7280; --line:#e5e7eb; --ink:#111827;
      /* palette (‡∏™‡∏ß‡∏¢‡πÅ‡∏•‡∏∞‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢) */
      --temp:#f97316;   /* orange  */
      --amps:#0ea5e9;   /* sky     */
      --cycles:#8b5cf6; /* violet  */
      --level:#22c55e;  /* green   */
      --tick:#94a3b8; --grid:#e5e7eb;
    }
    *{box-sizing:border-box}
    html{color-scheme:light}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:1280px;margin:18px auto;padding:0 16px}

    /* Top bar */
    .topbar{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    h1{margin:0 8px 0 0;font-size:22px}
    .sub{font-size:12px;color:var(--muted)}
    .right{margin-left:auto;display:flex;gap:6px;flex-wrap:wrap;align-items:center}
    .btn{border:1px solid var(--line);background:#fff;padding:6px 10px;border-radius:10px;cursor:pointer;font-size:12px}
    .btn.active{background:#111;color:#fff;border-color:#111}
    .badge{padding:2px 8px;border-radius:999px;font-size:11px;background:#eef2ff;color:#4338ca}

    /* KPI cards */
    .grid{display:grid;gap:12px}
    .cards{grid-template-columns:repeat(4,minmax(0,1fr));margin-top:12px}
    @media(max-width:1024px){.cards{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:640px){.cards{grid-template-columns:1fr}}
    .card{background:var(--card);border-radius:12px;box-shadow:0 1px 2px rgba(0,0,0,.06);padding:12px}
    .k-label{font-size:12px;color:var(--muted)}
    .k-value{font-size:28px;font-weight:800;margin-top:4px}
    .k-sub{font-size:11px;color:var(--muted);margin-top:4px}
    .chip{font-size:11px;padding:2px 8px;border-radius:999px;background:#e5f6ed;color:#16a34a;font-weight:700}

    /* Chart panels */
    .panel{background:var(--card);border-radius:12px;box-shadow:0 1px 2px rgba(0,0,0,.06);padding:10px}
    .two{grid-template-columns:1fr 1fr}
    .panel h3{margin:0 0 6px 2px;font-size:13px;color:var(--muted);display:flex;align-items:center;gap:8px}
    .chart-wrap{height:210px}
    canvas{width:100%;height:100%;background:#fff;border-radius:10px}

    /* Footer */
    .footer{display:flex;gap:14px;align-items:center;color:var(--muted);font-size:12px;margin-top:10px}
    .ok{color:#16a34a}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <h1>IoT Sensor Dashboard</h1>
      <div class="sub">Device: <b>{{ device_id }}</b> ‚Ä¢ Real-time monitoring</div>
      <div class="badge" id="now-str">‚Äî</div>

      <div class="right">
        <button class="btn range active" data-hours="1">1h</button>
        <button class="btn range" data-hours="4">4h</button>
        <button class="btn range" data-hours="24">24h</button>

        <button id="btn-refresh" class="btn" title="Refresh">‚ü≥</button>
        <button id="btn-auto" class="btn" title="Toggle auto refresh">Auto: ON</button>
        <button id="btn-csv" class="btn" title="Download CSV">‚¨á CSV</button>

        <span class="sub">Firebase: <b id="fb-active">‚Äî</b></span>
        <button id="fb-to-primary"  class="btn">Primary</button>
        <button id="fb-to-secondary" class="btn">Secondary</button>
      </div>
    </div>

    <!-- KPI CARDS -->
    <div class="grid cards">
      <div class="card">
        <div class="k-label">Temperature</div>
        <div class="k-value"><span id="k-tempc">‚Äî</span><span style="font-weight:600">¬∞C</span></div>
        <div class="k-sub"><span id="k-tempf">‚Äî</span>¬∞F ‚Ä¢ <span id="k-temp-badge" class="chip" style="display:none"></span></div>
      </div>
      <div class="card">
        <div class="k-label">Current</div>
        <div class="k-value"><span id="k-amps">‚Äî</span><span style="font-weight:600">A</span></div>
        <div class="k-sub"><span id="k-amps-status" class="chip" style="display:none"></span></div>
      </div>
      <div class="card">
        <div class="k-label">Cycles</div>
        <div class="k-value"><span id="k-cycles">‚Äî</span></div>
        <div class="k-sub"><span id="k-cycles-status" class="chip" style="display:none"></span></div>
      </div>
      <div class="card">
        <div class="k-label">Level</div>
        <div class="k-value"><span id="k-level">‚Äî</span><span style="font-weight:600">cm</span></div>
        <div class="k-sub"><span id="k-level-pct">‚Äî</span>% ‚Ä¢ <span id="k-level-status" class="chip" style="display:none"></span></div>
      </div>
    </div>

    <!-- CHARTS -->
    <div class="grid two" style="margin-top:12px">
      <div class="panel">
        <h3>üå°Ô∏è Temperature Trend</h3>
        <div class="chart-wrap"><canvas id="c-temp"></canvas></div>
      </div>
      <div class="panel">
        <h3>‚ö° Current Flow</h3>
        <div class="chart-wrap"><canvas id="c-current"></canvas></div>
      </div>
      <div class="panel">
        <h3>üîÅ Cycle Rate</h3>
        <div class="chart-wrap"><canvas id="c-cycles"></canvas></div>
      </div>
      <div class="panel">
        <h3>üìè Level Monitoring</h3>
        <div class="chart-wrap"><canvas id="c-level"></canvas></div>
      </div>
    </div>

    <div class="footer">
      <span>‚Ä¢ Live Data</span>
      <span>Last updated: <span id="last-upd">‚Äî</span></span>
      <span>Records: <span id="rec-count">0</span></span>
      <span>Device Status: <span id="dev-status" class="ok">Online</span></span>
      <span>Uptime: <span id="uptime">‚Äî</span></span>
    </div>
  </div>

<script>
/* ========== Utils & theme ========== */
const $ = (q)=>document.querySelector(q);
const nowLbl = ()=>{
  const d = new Date();
  $('#now-str').textContent = d.toLocaleString(undefined,{hour12:false}) +
    ' (' + Intl.DateTimeFormat().resolvedOptions().timeZone + ')';
};
setInterval(nowLbl, 1000); nowLbl();

const fmtTS = (s)=> s ? new Date(s).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '‚Äî';
const css = getComputedStyle(document.documentElement);
const PAL = {
  temp:   css.getPropertyValue('--temp').trim()   || '#f97316',
  amps:   css.getPropertyValue('--amps').trim()   || '#0ea5e9',
  cycles: css.getPropertyValue('--cycles').trim() || '#8b5cf6',
  level:  css.getPropertyValue('--level').trim()  || '#22c55e',
  tick:   css.getPropertyValue('--tick').trim()   || '#94a3b8',
  grid:   css.getPropertyValue('--grid').trim()   || '#e5e7eb',
};

function addAlpha(hexOrRgb, a){
  if(hexOrRgb.startsWith('#')){
    const c = hexOrRgb.length===4
      ? hexOrRgb.slice(1).split('').map(h=>h+h).join('')
      : hexOrRgb.slice(1);
    const r=parseInt(c.slice(0,2),16), g=parseInt(c.slice(2,4),16), b=parseInt(c.slice(4,6),16);
    return `rgba(${r},${g},${b},${a})`;
  }
  if(hexOrRgb.startsWith('rgb')){
    const m = hexOrRgb.match(/rgba?\(([^)]+)\)/);
    if(!m) return hexOrRgb;
    const [r,g,b] = m[1].split(',').slice(0,3).map(x=>+x.trim());
    return `rgba(${r},${g},${b},${a})`;
  }
  return hexOrRgb;
}

function areaConfig(label, lineColor){
  return {
    type:'line',
    data:{labels:[], datasets:[{
      label, data:[], borderColor:lineColor, borderWidth:2, fill:true,
      backgroundColor:(ctx)=>{
        const chart = ctx.chart; const area = chart.chartArea;
        if(!area) return addAlpha(lineColor, .0);
        const g = chart.ctx.createLinearGradient(0, area.top, 0, area.bottom);
        g.addColorStop(0, addAlpha(lineColor, .22));
        g.addColorStop(1, addAlpha(lineColor, 0));
        return g;
      },
      tension:.25, pointRadius:0, pointHitRadius:8, spanGaps:true,
    }]},
    options:{
      responsive:true, maintainAspectRatio:false,
      animation:{duration:600, easing:'easeOutQuart'},
      interaction:{mode:'index', intersect:false},
      parsing:false,
      plugins:{
        legend:{display:false},
        tooltip:{
          displayColors:false,
          callbacks:{ label:(it)=> `${label}: ${Number(it.parsed.y).toFixed(2)}` }
        },
        decimation:{ enabled:true, algorithm:'lttb', samples:60 },
      },
      scales:{
        x:{ grid:{display:false}, ticks:{color:PAL.tick, maxRotation:0, autoSkip:true, maxTicksLimit:8} },
        y:{ grid:{color:PAL.grid},   ticks:{color:PAL.tick, maxTicksLimit:4} }
      }
    }
  };
}

/* ========== Build charts ========== */
const charts = {
  temp:    new Chart($('#c-temp'),    areaConfig('Temp (¬∞C)', PAL.temp)),
  current: new Chart($('#c-current'), areaConfig('Current (A)', PAL.amps)),
  cycles:  new Chart($('#c-cycles'),  areaConfig('Cycles (cpm)', PAL.cycles)),
  level:   new Chart($('#c-level'),   areaConfig('Level (cm)', PAL.level)),
};

let autoOn=true, lastHours=1, lastHistoryCache={};

/* ========== Fetch helper ========== */
async function jget(url){
  const r = await fetch(url + (url.includes('?')?'&':'?') + 'bust=' + Date.now());
  if(!r.ok) throw new Error('HTTP '+r.status);
  const ct = r.headers.get('Content-Type')||'';
  if(!ct.includes('application/json')) throw new Error('Bad content-type');
  return r.json();
}

/* ========== Latest (KPI) ========== */
async function loadLatest(){
  try{
    const j = await jget('/api/latest/');
    const tv = Number(j.temp?.value);
    $('#k-tempc').textContent = Number.isFinite(tv)? tv.toFixed(2) : '‚Äî';
    $('#k-tempf').textContent = j.temp?.temp_f ?? '‚Äî';

    const tb = $('#k-temp-badge');
    if(Number.isFinite(tv)){
      if(tv < 5){ tb.textContent='Low'; tb.style.display='inline-block'; tb.style.background='#e0f2fe'; tb.style.color='#0369a1'; }
      else if(tv > 45){ tb.textContent='High'; tb.style.display='inline-block'; tb.style.background='#fee2e2'; tb.style.color='#b91c1c'; }
      else { tb.textContent='Normal'; tb.style.display='inline-block'; tb.style.background='#e5f6ed'; tb.style.color='#16a34a'; }
    }

    const av = Number(j.current?.value);
    $('#k-amps').textContent = Number.isFinite(av)? av.toFixed(2) : '‚Äî';
    const ab = $('#k-amps-status');
    if(Number.isFinite(av)){
      const hi = av>10;
      ab.textContent = hi ? 'High' : 'Normal';
      ab.style.display='inline-block';
      ab.style.background = hi ? '#fee2e2' : '#e5f6ed';
      ab.style.color      = hi ? '#b91c1c' : '#16a34a';
    }

    $('#k-level').textContent = j.level?.value ?? '‚Äî';
    $('#k-level-pct').textContent = j.level?.percent ?? '‚Äî';
    const lb = $('#k-level-status');
    if(j.level?.percent != null){
      const p = Number(j.level.percent);
      lb.textContent = (p<20?'Low': p>90?'High':'Normal');
      lb.style.display='inline-block';
      lb.style.background = (p<20||p>90)?'#fff7ed':'#e5f6ed';
      lb.style.color      = (p<20||p>90)?'#b45309':'#16a34a';
    }

    $('#k-cycles').textContent = Number(j.cycles?.value ?? NaN) || '‚Äî';
    $('#k-cycles-status').textContent = 'Active';
    $('#k-cycles-status').style.display='inline-block';

    const ts = j.temp?.timestamp || j.current?.timestamp || j.level?.timestamp;
    $('#last-upd').textContent = ts ? new Date(ts).toLocaleString() : '‚Äî';
  }catch(e){ /* ‡πÅ‡∏Å‡∏•‡πâ‡∏á‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î read */ }
}

/* ========== History (‡∏Å‡∏£‡∏≤‡∏ü) ========== */
async function loadHistory(hours){
  lastHours = hours;
  const metrics = ['temp','current','level','cycles'];
  let total = 0;
  for(const m of metrics){
    try{
      const j = await jget(`/api/history/?metric=${m}&hours=${hours}`);
      lastHistoryCache[m] = j.items || [];
      total += j.count || (j.items?.length||0);

      const labels = (j.items||[]).map(x=>fmtTS(x.timestamp));
      const values = (j.items||[]).map(x=>Number(x.value));

      charts[m].data.labels = labels;
      charts[m].data.datasets[0].data = values;
      charts[m].update();
    }catch(e){
      charts[m].data.labels = [];
      charts[m].data.datasets[0].data = [];
      charts[m].update();
    }
  }
  $('#rec-count').textContent = total;
}

/* ========== CSV ========== */
function downloadCSV(){
  const rows = [['Timestamp','Temperature (¬∞C)','Current (A)','Cycles (cpm)','Level (cm)'].join(',')];

  // ‡∏™‡∏°‡∏°‡∏∏‡∏ï‡∏¥‡∏ß‡πà‡∏≤‡πÅ‡∏ï‡πà‡∏•‡∏∞ metric ‡∏°‡∏µ timestamp ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô (‡∏à‡∏≤‡∏Å minutes rollup)
  // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á ‡πÅ‡∏Å‡πâ‡∏ù‡∏±‡πà‡∏á backend aggregate ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏à‡∏∞‡∏™‡∏ß‡∏¢‡∏™‡∏∏‡∏î
  const map = new Map();
  for(const it of (lastHistoryCache.temp||[]))       map.set(it.timestamp, {t:it.value});
  for(const it of (lastHistoryCache.current||[])) { const r=map.get(it.timestamp)||{}; r.a=it.value; map.set(it.timestamp,r); }
  for(const it of (lastHistoryCache.cycles||[]))  { const r=map.get(it.timestamp)||{}; r.c=it.value; map.set(it.timestamp,r); }
  for(const it of (lastHistoryCache.level||[]))   { const r=map.get(it.timestamp)||{}; r.l=it.value; map.set(it.timestamp,r); }

  [...map.entries()].sort((a,b)=>a[0].localeCompare(b[0])).forEach(([ts,v])=>{
    rows.push([ts, v.t??'', v.a??'', v.c??'', v.l??''].join(','));
  });

  const blob = new Blob([rows.join('\n')], {type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `history_{{ device_id }}_${lastHours}h.csv`.replace(/\s+/g,'');
  a.click(); URL.revokeObjectURL(a.href);
}

/* ========== Firebase switcher ========== */
async function refreshActive(){
  try{
    const j = await jget('/api/firebase/active/');
    $('#fb-active').textContent = j.active || '‚Äî';
    $('#fb-to-primary').disabled  = (j.active==='primary')  || j.available?.primary===false;
    $('#fb-to-secondary').disabled= (j.active==='secondary')|| j.available?.secondary===false;
  }catch{ $('#fb-active').textContent='‚Äî'; }
}
async function switchTo(target){
  try{
    $('#fb-to-primary').disabled = $('#fb-to-secondary').disabled = true;
    const r = await fetch(`/api/firebase/active/set/?to=${encodeURIComponent(target)}`);
    if(!r.ok) throw new Error('HTTP '+r.status);
    const j = await r.json();
    if(!j.ok) throw new Error(j.error||'switch failed');
  }catch(e){ alert('Switch error: '+e.message); }
  finally{ await refreshActive(); await loadLatest(); }
}

/* ========== Auto refresh ========== */
let tKpi=0;
function setupAuto(){
  clearInterval(tKpi);
  if(!autoOn) return;
  tKpi = setInterval(loadLatest, 30_000); // KPI 30s
}

/* ========== UI bindings ========== */
document.querySelectorAll('.btn.range').forEach(b=>{
  b.onclick=()=>{
    document.querySelectorAll('.btn.range').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    loadHistory(Number(b.dataset.hours||'4'));
  };
});
$('#btn-refresh').onclick=()=>{ loadLatest(); loadHistory(lastHours); };
$('#btn-auto').onclick=()=>{ autoOn=!autoOn; $('#btn-auto').textContent='Auto: '+(autoOn?'ON':'OFF'); setupAuto(); };
$('#btn-csv').onclick=downloadCSV;
$('#fb-to-primary').onclick = ()=>switchTo('primary');
$('#fb-to-secondary').onclick = ()=>switchTo('secondary');

/* ========== Kickoff ========== */
(async()=>{
  await refreshActive();
  await loadLatest();
  await loadHistory(1);
  setupAuto();
})();
</script>
</body>
</html>
